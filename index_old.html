<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Phenakistoscope Simulator - Retro Instrument Panel</title>
<style>
  body {
    background: radial-gradient(circle at center, #111 0%, #000 100%);
    color: #eee;
    font-family: 'Courier New', monospace;
    text-align: center;
    margin: 0;
    padding: 20px;
  }
  canvas {
    background: #000;
    border: 2px solid #555;
    border-radius: 50%;
    display: block;
    margin: 20px auto;
    box-shadow: 0 0 20px #0f0a, inset 0 0 10px #333;
  }
  .controls {
    margin-bottom: 15px;
    padding: 15px;
    border-radius: 12px;
    background: linear-gradient(180deg, #444, #222);
    box-shadow: inset 0 2px 6px rgba(0,0,0,0.6), 0 2px 10px rgba(0,0,0,0.5);
    display: inline-block;
  }
  button, input[type="file"], input[type="text"], input[type="range"], select {
    margin: 4px;
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid #555;
    background: #222;
    color: #eee;
    font-family: 'Courier New', monospace;
    transition: all 0.2s ease-in-out;
  }
  button:hover {
    background: #444;
    box-shadow: 0 0 10px #0f0;
  }
  .indicator {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #300;
    box-shadow: 0 0 4px #000;
    margin-left: 8px;
  }
  .indicator.on {
    background: #0f0;
    box-shadow: 0 0 10px #0f0;
  }
  #statusMessage {
    color: #ccc;
    font-size: 14px;
    margin-top: 8px;
  }
  .speed-control {
    display: inline-flex;
    align-items: center;
    margin: 5px;
  }
  .speed-value {
    width: 50px;
    text-align: right;
    margin-left: 5px;
    color: #0f0;
  }
</style>
</head>
<body>
<h1>Phenakistoscope Simulator üéûÔ∏è</h1>

<div class="controls">
  <div>
    <input type="file" id="fileInput" accept="image/*" />
    <input type="text" id="imageUrlInput" placeholder="Enter image URL" size="30" />
    <button id="loadUrlBtn">Load URL</button>
  </div>
  <hr style="border:1px solid #333">
  <div>
    <button id="startStopBtn">‚ñ∂Ô∏è Start</button>
    <div class="indicator" id="indicator"></div>
    <button id="resetBtn">üîÅ Reset</button>
    <button id="stepLeftBtn">‚ü≤ Step Left</button>
    <button id="stepRightBtn">‚ü≥ Step Right</button>
    <button id="directionBtn">‚Ü∫ Direction: CW</button>
    <div class="speed-control">
      <label for="speedSlider">Speed:</label>
      <input type="range" id="speedSlider" min="0.001" max="0.1" step="0.001" value="0.02" />
      <span class="speed-value" id="speedValue">0.020</span>
    </div>
    <label for="autoStopSelect">Auto-stop:</label>
    <select id="autoStopSelect">
      <option value="0">Off</option>
      <option value="5">5s</option>
      <option value="10">10s</option>
      <option value="30">30s</option>
    </select>
  </div>
</div>

<canvas id="phenakistoscopeCanvas" width="800" height="800"></canvas>
<p id="statusMessage">Ready.</p>

<script>
window.onload = function () {
  const canvas = document.getElementById('phenakistoscopeCanvas');
  const ctx = canvas.getContext('2d');
  const fileInput = document.getElementById('fileInput');
  const imageUrlInput = document.getElementById('imageUrlInput');
  const loadUrlBtn = document.getElementById('loadUrlBtn');
  const statusMessage = document.getElementById('statusMessage');
  const startStopBtn = document.getElementById('startStopBtn');
  const resetBtn = document.getElementById('resetBtn');
  const stepLeftBtn = document.getElementById('stepLeftBtn');
  const stepRightBtn = document.getElementById('stepRightBtn');
  const directionBtn = document.getElementById('directionBtn');
  const indicator = document.getElementById('indicator');
  const speedSlider = document.getElementById('speedSlider');
  const speedValue = document.getElementById('speedValue');
  const autoStopSelect = document.getElementById('autoStopSelect');

  let image = new Image();
  image.crossOrigin = "anonymous";
  image.src = "https://tclaret.github.io/phenakistoscope-simulator/McLean_1.png";
  image.onload = () => statusMessage.textContent = "‚úÖ Default image loaded (McLean_1.png)";

  let rotation = 0;
  let isRunning = false;
  let rotationSpeed = parseFloat(speedSlider.value);
  let direction = 1; // 1 = CW, -1 = CCW
  let frameCount = 12;
  let currentFrame = 0;
  let autoStopTimer = null;

  function drawPhenakistoscopeMirror() {
    ctx.save();
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.scale(-1, 1); // mirror horizontally
    ctx.rotate(rotation);

    const anglePerFrame = (2 * Math.PI) / frameCount;
    const startAngle = currentFrame * anglePerFrame;
    const endAngle = startAngle + anglePerFrame;

    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.arc(0, 0, canvas.width / 2, startAngle, endAngle);
    ctx.closePath();
    ctx.clip();

    if (image.complete && image.naturalWidth > 0) {
      ctx.drawImage(image, -canvas.width / 2, -canvas.height / 2, canvas.width, canvas.height);
    }
    ctx.restore();

    // draw slit mask
    ctx.save();
    ctx.strokeStyle = "#0f0";
    ctx.lineWidth = 1.2;
    for (let i = 0; i < frameCount; i++) {
      const a = (i / frameCount) * 2 * Math.PI;
      const x = canvas.width / 2 + Math.cos(a) * (canvas.width / 2 - 10);
      const y = canvas.height / 2 + Math.sin(a) * (canvas.height / 2 - 10);
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, canvas.height / 2);
      ctx.lineTo(x, y);
      ctx.stroke();
    }
    ctx.restore();
  }

  function animate() {
    if (isRunning) {
      rotation += direction * rotationSpeed;
      currentFrame = (currentFrame + 1) % frameCount;
    }
    drawPhenakistoscopeMirror();
    requestAnimationFrame(animate);
  }
  animate();

  // Load from file
  fileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      image = new Image();
      image.onload = () => {
        statusMessage.textContent = `‚úÖ Loaded image: ${file.name}`;
      };
      image.src = event.target.result;
    };
    reader.readAsDataURL(file);
  });

  // Load from URL
  loadUrlBtn.addEventListener("click", () => {
    const url = imageUrlInput.value.trim();
    if (!url) return;
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => {
      image = img;
      statusMessage.textContent = `‚úÖ Image loaded from URL: ${url}`;
    };
    img.onerror = () => {
      statusMessage.textContent = "‚ùå Could not load image (CORS restriction).";
    };
    img.src = url;
  });

  // Start/Stop
  startStopBtn.addEventListener("click", () => {
    isRunning = !isRunning;
    indicator.classList.toggle("on", isRunning);
    startStopBtn.textContent = isRunning ? "‚è∏ Stop" : "‚ñ∂Ô∏è Start";
    statusMessage.textContent = isRunning ? "üü¢ Rotation started." : "‚è∏ Rotation paused.";

    if (isRunning) {
      clearTimeout(autoStopTimer);
      const duration = parseInt(autoStopSelect.value);
      if (duration > 0) {
        autoStopTimer = setTimeout(() => {
          isRunning = false;
          indicator.classList.remove("on");
          startStopBtn.textContent = "‚ñ∂Ô∏è Start";
          statusMessage.textContent = `‚èπ Auto-stopped after ${duration}s.`;
        }, duration * 1000);
      }
    }
  });

  resetBtn.addEventListener("click", () => {
    rotation = 0;
    currentFrame = 0;
    statusMessage.textContent = "üîÅ Rotation reset.";
  });

  stepLeftBtn.addEventListener("click", () => {
    rotation -= 0.1;
    statusMessage.textContent = "‚ü≤ Stepped left.";
  });

  stepRightBtn.addEventListener("click", () => {
    rotation += 0.1;
    statusMessage.textContent = "‚ü≥ Stepped right.";
  });

  directionBtn.addEventListener("click", () => {
    direction *= -1;
    directionBtn.textContent = direction === 1 ? "‚Ü∫ Direction: CW" : "‚Üª Direction: CCW";
    statusMessage.textContent = direction === 1 ? "‚û°Ô∏è Clockwise rotation." : "‚¨ÖÔ∏è Counterclockwise rotation.";
  });

  speedSlider.addEventListener("input", () => {
    rotationSpeed = parseFloat(speedSlider.value);
    speedValue.textContent = rotationSpeed.toFixed(3);
  });
};
</script>
</body>
</html>
