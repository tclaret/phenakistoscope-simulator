<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Phenakistoscope Simulator ‚Äî Explore the Earliest Animation Discs</title>
<style>
  :root{
    --bg:#05121a;
    --panel:#0b1220;
    --muted:#9aa7bf;
    --accent:#6ee7b7;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#02050a 0%, var(--bg) 100%);color:#e8f0fb;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  .container{max-width:1200px;margin:18px auto;padding:18px;box-sizing:border-box;}
  header{display:flex;flex-direction:column;gap:6px;align-items:center;margin-bottom:14px}
  h1{margin:0;font-size:20px;font-weight:600}
  .layout{display:grid;grid-template-columns:360px 1fr;gap:20px;align-items:start}
  @media (max-width:920px){ .layout{grid-template-columns:1fr} }
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.7)}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  select,input[type=text],input[type=file],button{width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;font-size:14px}
  .controlsPanel{display:flex;flex-direction:column;gap:10px}
  .instrument{display:flex;flex-direction:column;gap:10px;padding:8px;border-radius:10px;background:linear-gradient(180deg,#0e1518,#061015);box-shadow:inset 0 2px 8px rgba(0,0,0,0.5)}
  .controls-top{display:flex;gap:8px;flex-wrap:wrap}
  .controls-top>div{flex:1 1 160px;min-width:140px}
  .controls-bottom{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .btn{padding:8px 10px;border-radius:8px;background:#0b1620;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
  .btn:hover{transform:translateY(-1px)}
  .indicator{width:12px;height:12px;border-radius:50%;background:#300;margin-left:8px}
  .indicator.on{background:var(--accent);box-shadow:0 0 10px var(--accent)}
  .speedWrap{display:flex;align-items:center;gap:8px}
  .speedValue{min-width:56px;text-align:right;color:var(--accent)}
  .viewer{display:flex;flex-direction:column;gap:10px;align-items:center}
  .canvasWrap{position:relative;width:100%;display:flex;justify-content:center;align-items:center;padding:12px}
  canvas{background:#000;border-radius:16px;max-width:calc(100% - 36px);height:auto;box-shadow: 0 12px 40px rgba(1,6,14,0.9)}
  .glowRing{position:absolute;pointer-events:none;border-radius:50%;filter:blur(20px);mix-blend-mode:screen;transition:opacity 0.25s}
  .inset{position:absolute;right:22px;bottom:22px;width:140px;height:140px;border-radius:50%;overflow:hidden;border:3px solid rgba(255,255,255,0.04);display:none}
  .thumbnail{margin-top:8px;display:flex;justify-content:center}
  .thumbImg{width:140px;height:140px;object-fit:cover;border-radius:8px;opacity:0;transition:opacity 360ms ease}
  .spinner{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:64px;height:64px;border-radius:50%;display:none;align-items:center;justify-content:center}
  .spinner.visible{display:flex}
  .spinner .dot{width:14px;height:14px;border-radius:50%;background:var(--accent);animation:spin 1s linear infinite}
  @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
  footer{margin-top:10px;color:var(--muted);font-size:14px}
  footer a{color:var(--accent);text-decoration:none}
  .about{margin-top:14px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));font-size:14px;color:var(--muted)}
  @media (max-width:520px){ .inset{display:none} .thumbImg{width:120px;height:120px} }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Phenakistoscope Simulator ‚Äî Explore the Earliest Animation Discs</h1>
    <div style="font-size:13px;color:var(--muted)">Interactive viewer ‚Äî choose a disc, drag to spin, or use controls.</div>
  </header>

  <div class="layout">
    <div class="panel controlsPanel">
      <div class="instrument">
        <div class="controls-top">
          <div>
            <label for="discSelect">Choose a disc</label>
            <select id="discSelect"></select>
            <div class="thumbnail">
              <img id="thumbnail" class="thumbImg" src="" alt="selected disc">
            </div>
          </div>

          <div>
            <label for="fileInput">Upload image</label>
            <input id="fileInput" type="file" accept="image/*" />
            <label style="margin-top:8px">Or paste image URL</label>
            <div style="display:flex;gap:8px">
              <input id="imageUrl" type="text" placeholder="https://...jpg" />
              <button id="loadUrl" class="btn">Load</button>
            </div>
          </div>
        </div>

        <div style="border-top:1px solid rgba(255,255,255,0.03);padding-top:10px">
          <div class="controls-bottom">
            <div style="display:flex;align-items:center;gap:8px">
              <button id="startStop" class="btn">‚ñ∂Ô∏è Start</button>
              <div id="indicator" class="indicator"></div>
              <button id="reverseBtn" class="btn">‚áÑ Reverse</button>
              <button id="resetBtn" class="btn">üîÅ Reset</button>
            </div>

            <div class="speedWrap">
              <label for="speed">Speed</label>
              <input id="speed" type="range" min="0.001" max="0.12" step="0.001" value="0.02" />
              <div class="speedValue" id="speedValue">0.020</div>
            </div>

            <div style="display:flex;gap:8px;align-items:center">
              <label for="light">Light</label>
              <input id="light" type="range" min="0" max="1" step="0.01" value="0.6" />
              <div class="speedValue" id="lightValue">0.60</div>
            </div>

            <div style="display:flex;gap:8px;align-items:center">
              <label for="viewMode">View</label>
              <select id="viewMode">
                <option value="photo">Photo</option>
                <option value="simulation">Simulation</option>
                <option value="realistic">Realistic</option>
              </select>
              <button id="toggleInset" class="btn">Toggle Inset</button>
            </div>
          </div>
        </div>

        <div style="margin-top:6px;color:var(--muted);font-size:13px">Status: <span id="status">Ready</span></div>
      </div>
    </div>

    <div class="panel viewer">
      <div class="canvasWrap">
        <div id="glow" class="glowRing" style="width:860px;height:860px;opacity:0;"></div>

        <canvas id="viewCanvas" width="800" height="800" aria-label="Phenakistoscope view"></canvas>

        <div id="inset" class="inset">
          <canvas id="insetCanvas" width="200" height="200"></canvas>
        </div>

        <div id="spinner" class="spinner"><div class="dot"></div></div>
      </div>

      <footer class="about">
        <strong>About the phenakistoscope</strong>
        <p style="margin:6px 0 8px 0;color:var(--muted)">The phenakistoscope (also spelled phenakistiscope) is an early animation device that creates the illusion of motion from a sequence of pictures. Select a disc to view the animation and experiment with speed, lighting, and manual spinning.</p>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <a href="https://en.wikipedia.org/wiki/Phenakistiscope" target="_blank" rel="noopener">Wikipedia ‚Äî Phenakistiscope</a>
          <a href="https://www.acmi.net.au/works/100515--phenakistoscope-discs/" target="_blank" rel="noopener">ACMI ‚Äî Phenakistoscope Discs</a>
          <a href="https://www.fantasy-animation.org/current-posts/what-is-a-phenakistoscope" target="_blank" rel="noopener">What is a Phenakistoscope? ‚Äî Fantasy Animation</a>
        </div>
      </footer>
    </div>
  </div>
</div>

<script>
window.onload = function() {
  console.log("Phenakistoscope v3 starting...");

  // All images from your images/ folder (use exactly these filenames)
  const imageFiles = [
    "9965f708-6fd1-43a3-8b4a-9b29a187c1f8.png",
    "a_cheval.png",
    "AEO175939_PhenakistoscopeGiroux60.jpg",
    "AEO185553_PhenakistiscopeDisc_ManInBlueAndRed.jpg",
    "Dancing.jpg",
    "frame_2.png",
    "Gernamy_1949_R_Balzer.png",
    "Jongleur.png",
    "jongleur.png",
    "McLean_1.png",
    "medium_1990_5036_3369.jpg",
    "medium_a001813b.jpg",
    "ppmsca.jpg",
    "phenakistoscope-4.gif",
    "tumblr_oc1czn99ZM1r9jbwno1_500.png",
    "tumblr_oc1d3skVsF1r9jbwno1_500.png",
    "tumblr_oc1d4wZeB81r9jbwno1_500.png",
    "tumblr_oc1d6377G91r9jbwno1_500.png",
    "tumblr_oc1d7io0Kp1r9jbwno1_500.png",
    "tumblr_oc1da70gPN1r9jbwno1_500.png",
    "WomanChoppingTree.jpg"
  ];

  // DOM refs
  const discSelect = document.getElementById('discSelect');
  const thumbnail = document.getElementById('thumbnail');
  const fileInput = document.getElementById('fileInput');
  const imageUrl = document.getElementById('imageUrl');
  const loadUrl = document.getElementById('loadUrl');
  const viewModeSel = document.getElementById('viewMode');
  const startStop = document.getElementById('startStop');
  const reverseBtn = document.getElementById('reverseBtn');
  const resetBtn = document.getElementById('resetBtn');
  const indicator = document.getElementById('indicator');
  const speedSlider = document.getElementById('speed');
  const speedValue = document.getElementById('speedValue');
  const lightSlider = document.getElementById('light');
  const lightValue = document.getElementById('lightValue');
  const toggleInset = document.getElementById('toggleInset');
  const insetDiv = document.getElementById('inset');
  const spinner = document.getElementById('spinner');
  const status = document.getElementById('status');
  const glow = document.getElementById('glow');

  const canvas = document.getElementById('viewCanvas');
  const ctx = canvas.getContext('2d');
  const insetCanvas = document.getElementById('insetCanvas');
  const insetCtx = insetCanvas.getContext('2d');

  // state
  let discImage = new Image();
  let backgroundFrame = new Image();
  backgroundFrame.src = "images/frame_2.png";

  let viewMode = 'photo';
  let isRunning = false;
  let rotation = 0;
  let rotationVelocity = 0;   // actual angular velocity (radians/frame)
  let rotationSpeed = parseFloat(speedSlider.value); // base speed used for auto-run
  let showInset = false;
  let autoStopTimer = null;
  let glowIntensity = parseFloat(lightSlider.value);

  // drag spin variables
  let isDragging = false;
  let lastPointerAngle = 0;
  let lastPointerTime = 0;
  let pointerVelSamples = []; // recent samples of angular velocity

  // helpers
  function pathFor(filename){ return "images/" + filename; }

  function populateDropdown(){
    discSelect.innerHTML = '';
    imageFiles.forEach((f) => {
      const opt = document.createElement('option');
      opt.value = f; opt.textContent = f;
      discSelect.appendChild(opt);
    });
    // default first
    discSelect.selectedIndex = 0;
    loadSelectedDisc();
  }

  function showSpinner(on){ spinner.classList.toggle('visible', !!on); }

  function updateThumbnail(src){
    thumbnail.style.opacity = 0;
    thumbnail.onload = () => { thumbnail.style.opacity = 1; };
    thumbnail.src = src;
  }

  // load from images/ folder (photo mode default)
  function loadSelectedDisc(){
    const f = discSelect.value;
    if(!f) return;
    const p = pathFor(f);
    showSpinner(true);
    const img = new Image();
    img.onload = () => {
      discImage = img;
      updateThumbnail(p);
      status.textContent = "Loaded " + f;
      showSpinner(false);
      console.log("Loaded", p);
    };
    img.onerror = (e) => {
      status.textContent = "Error loading " + f;
      showSpinner(false);
      console.error("Error loading image", p, e);
    };
    img.src = p;
  }

  // local upload via FileReader -> base64 data URL
  fileInput.addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    showSpinner(true);
    status.textContent = "Loading local file...";
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        discImage = img;
        updateThumbnail(ev.target.result);
        status.textContent = "Loaded local " + f.name;
        showSpinner(false);
        console.log("Local loaded", f.name);
      };
      img.onerror = () => { status.textContent = "Failed to load local file"; showSpinner(false); };
      img.src = ev.target.result;
    };
    reader.onerror = () => { status.textContent = "File read error"; showSpinner(false); };
    reader.readAsDataURL(f);
  });

  // load by URL
  loadUrl.addEventListener('click', ()=>{
    const url = imageUrl.value.trim();
    if(!url) { status.textContent = "Enter image URL"; return; }
    showSpinner(true); status.textContent = "Loading URL...";
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => {
      discImage = img;
      updateThumbnail(url);
      status.textContent = "Loaded from URL";
      showSpinner(false);
    };
    img.onerror = (e) => { status.textContent = "Failed to load URL (CORS?)"; showSpinner(false); console.error(e); };
    img.src = url;
  });

  // view change
  viewModeSel.addEventListener('change', (e) => {
    viewMode = e.target.value;
    status.textContent = "View: " + viewMode;
  });

  // start/stop toggle
  startStop.addEventListener('click', ()=>{
    isRunning = !isRunning;
    indicator.classList.toggle('on', isRunning);
    startStop.textContent = isRunning ? "‚è∏ Pause" : "‚ñ∂Ô∏è Start";
    status.textContent = isRunning ? "Playing" : "Paused";
    if(!isRunning && autoStopTimer){ clearTimeout(autoStopTimer); autoStopTimer = null; }
  });

  // reverse spin
  reverseBtn.addEventListener('click', ()=>{
    rotationVelocity = -rotationVelocity;
    status.textContent = "Direction reversed";
  });

  // reset
  resetBtn.addEventListener('click', ()=>{
    rotation = 0; rotationVelocity = 0; status.textContent = "Reset";
  });

  // speed slider
  speedSlider.addEventListener('input', (e)=>{
    rotationSpeed = parseFloat(e.target.value);
    speedValue.textContent = rotationSpeed.toFixed(3);
  });

  // light slider
  lightSlider.addEventListener('input', (e)=>{
    glowIntensity = parseFloat(e.target.value);
    lightValue.textContent = glowIntensity.toFixed(2);
  });

  // toggle inset
  toggleInset.addEventListener('click', ()=>{
    showInset = !showInset;
    insetDiv.style.display = showInset ? 'block' : 'none';
  });

  // dropdown change
  discSelect.addEventListener('change', loadSelectedDisc);

  // resize canvas for DPR and responsiveness
  function resizeCanvas(){
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    const size = Math.min(Math.max(400, rect.width), 900);
    canvas.width = Math.floor(size * dpr);
    canvas.height = canvas.width;
    // inset
    const irect = insetCanvas.getBoundingClientRect();
    insetCanvas.width = Math.floor(irect.width * dpr);
    insetCanvas.height = Math.floor(irect.height * dpr);
  }
  window.addEventListener('resize', resizeCanvas);

  // draw glow
  function drawGlow(opacity){
    const el = glow;
    const size = Math.min(canvas.width, canvas.height) + 80;
    el.style.width = size + 'px';
    el.style.height = size + 'px';
    const cx = canvas.getBoundingClientRect().left + canvas.offsetWidth/2 - size/2;
    const cy = canvas.getBoundingClientRect().top + canvas.offsetHeight/2 - size/2;
    el.style.left = cx + 'px';
    el.style.top = cy + 'px';
    el.style.background = `radial-gradient(circle, rgba(110,231,183,${0.25*opacity}) 0%, rgba(110,231,183,${0.02*opacity}) 35%, rgba(0,0,0,0) 65%)`;
    el.style.opacity = opacity>0.01 ? Math.min(1, opacity) : 0;
  }

  // draw photo mode (circular disc)
  function drawPhoto(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const cx = canvas.width/2, cy = canvas.height/2;
    const r = canvas.width * 0.42;
    // subtle background
    ctx.fillStyle = "#000";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // faint frame behind
    if(backgroundFrame.complete && backgroundFrame.naturalWidth>0){
      ctx.save();
      ctx.globalAlpha = 0.06;
      const s = (canvas.width*1.0)/backgroundFrame.naturalWidth;
      const bw = backgroundFrame.naturalWidth * s, bh = backgroundFrame.naturalHeight * s;
      ctx.drawImage(backgroundFrame, cx - bw/2, cy - bh/2, bw, bh);
      ctx.restore();
    }

    // shadow
    ctx.beginPath(); ctx.arc(cx, cy + r*0.06, r*1.02, 0, Math.PI*2); ctx.fillStyle = "rgba(0,0,0,0.45)"; ctx.fill();

    if(discImage && discImage.complete && discImage.naturalWidth>0){
      ctx.save(); ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.closePath(); ctx.clip();
      ctx.translate(cx, cy); ctx.rotate(rotation);
      const s = Math.max((r*2)/discImage.width, (r*2)/discImage.height);
      const iw = discImage.width * s, ih = discImage.height * s;
      ctx.drawImage(discImage, -iw/2, -ih/2, iw, ih); ctx.restore();
    }

    // rim
    ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.lineWidth = Math.max(6, canvas.width*0.008); ctx.strokeStyle = "rgba(255,255,255,0.06)"; ctx.stroke();

    // holes ring
    const holes = 24;
    const holeR = Math.max(4, canvas.width*0.006);
    for(let i=0;i<holes;i++){
      const a = i * (Math.PI*2/holes) + rotation;
      const hx = cx + Math.cos(a)*(r*0.92), hy = cy + Math.sin(a)*(r*0.92);
      ctx.beginPath(); ctx.arc(hx,hy,holeR,0,Math.PI*2); ctx.fillStyle="rgba(0,0,0,0.65)"; ctx.fill();
      ctx.lineWidth = 1; ctx.strokeStyle = "rgba(255,255,255,0.04)"; ctx.stroke();
    }

    // center pin
    ctx.beginPath(); ctx.arc(cx,cy,Math.max(6,canvas.width*0.01),0,Math.PI*2); ctx.fillStyle="#222"; ctx.fill();
    ctx.lineWidth=2; ctx.strokeStyle="rgba(255,255,255,0.06)"; ctx.stroke();

    // vignette
    const g = ctx.createRadialGradient(cx,cy,r*0.2,cx,cy,r*1.1); g.addColorStop(0,"rgba(0,0,0,0)"); g.addColorStop(1,"rgba(0,0,0,0.45)");
    ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width,canvas.height);
  }

  // simulation mode: flat spinning with slit mask
  function drawSimulation(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const cx = canvas.width/2, cy = canvas.height/2;
    ctx.fillStyle = "#070b10"; ctx.fillRect(0,0,canvas.width,canvas.height);

    if(discImage && discImage.complete && discImage.naturalWidth>0){
      ctx.save(); ctx.translate(cx,cy); ctx.rotate(rotation);
      const s = Math.min((canvas.width*0.9)/discImage.width,(canvas.height*0.9)/discImage.height);
      const iw = discImage.width*s, ih = discImage.height*s; ctx.drawImage(discImage,-iw/2,-ih/2,iw,ih); ctx.restore();
    }

    // slit mask
    const slits = 12; const slitW = 10 * Math.PI/180;
    ctx.save(); ctx.translate(cx,cy); ctx.rotate(-rotation);
    ctx.globalCompositeOperation = "destination-in"; ctx.beginPath();
    for(let i=0;i<slits;i++){ const a = i*(2*Math.PI/slits)-slitW/2; ctx.moveTo(0,0); ctx.arc(0,0,Math.max(canvas.width,canvas.height),a,a+slitW); }
    ctx.fillStyle="#fff"; ctx.fill(); ctx.restore();
  }

  // realistic mode: small mirrored disc + subtle overlay
  function drawRealistic(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(backgroundFrame && backgroundFrame.complete && backgroundFrame.naturalWidth>0){
      ctx.save(); ctx.globalAlpha = 0.12;
      const s = Math.min(canvas.width/backgroundFrame.naturalWidth, canvas.height/backgroundFrame.naturalHeight)*1.2;
      const bw = backgroundFrame.naturalWidth*s, bh = backgroundFrame.naturalHeight*s; ctx.drawImage(backgroundFrame,(canvas.width-bw)/2,(canvas.height-bh)/2,bw,bh); ctx.restore();
    }

    const cx = canvas.width/2, cy = canvas.height/2, r = canvas.width*0.35;
    ctx.save(); ctx.translate(cx,cy); ctx.scale(-1,1); ctx.rotate(rotation);
    if(discImage && discImage.complete && discImage.naturalWidth>0){
      const s = Math.max((r*2)/discImage.width, (r*2)/discImage.height);
      ctx.drawImage(discImage,-r,-r,r*2,r*2);
    }
    ctx.restore();

    ctx.save(); ctx.globalAlpha = 0.25; ctx.fillStyle="black"; ctx.fillRect(0,cy-60,canvas.width,120); ctx.restore();
  }

  // inset draw
  function drawInset(){
    insetCtx.clearRect(0,0,insetCanvas.width,insetCanvas.height);
    if(!showInset) return;
    insetCtx.save(); insetCtx.translate(insetCanvas.width/2,insetCanvas.height/2); insetCtx.rotate(rotation);
    if(discImage && discImage.complete && discImage.naturalWidth>0){
      const s = Math.max(insetCanvas.width/discImage.width, insetCanvas.height/discImage.height);
      const iw = discImage.width*s, ih = discImage.height*s; insetCtx.drawImage(discImage,-iw/2,-ih/2,iw,ih);
    }
    insetCtx.restore();
    insetCtx.beginPath(); insetCtx.arc(insetCanvas.width/2,insetCanvas.height/2,insetCanvas.width/2 - 2,0,Math.PI*2); insetCtx.lineWidth = 3; insetCtx.strokeStyle="rgba(255,255,255,0.06)"; insetCtx.stroke();
  }

  // main render loop
  function render(){
    // glow uses running state and light slider
    const glowOp = isRunning ? (0.4 + 0.6*Math.abs(Math.sin(rotation*0.2))) * glowIntensity : 0.05 * glowIntensity;
    drawGlow(glowOp);

    if(viewMode === 'photo') drawPhoto();
    else if(viewMode === 'simulation') drawSimulation();
    else drawRealistic();

    drawInset();
    requestAnimationFrame(render);
  }

  // physics: update rotation by velocity; apply friction when not driven
  function physicsStep(){
    // if running and no manual velocity (i.e., autoplay), ensure velocity approaches rotationSpeed
    if(isRunning && Math.abs(rotationVelocity) < Math.abs(rotationSpeed*1.2)){
      // gradually nudge velocity toward rotationSpeed (same direction)
      const target = rotationSpeed * Math.sign(rotationVelocity || 1);
      rotationVelocity += (target - rotationVelocity) * 0.03;
    }
    // apply velocity
    rotation += rotationVelocity;
    // friction / decay
    rotationVelocity *= isDragging ? 0.995 : 0.995;
    // keep within reasonable range
    if(Math.abs(rotationVelocity) < 0.000001) rotationVelocity = 0;
    requestAnimationFrame(physicsStep);
  }

  // convert pointer to angle around canvas center
  function pointerAngle(clientX, clientY){
    const rect = canvas.getBoundingClientRect();
    const cx = rect.left + rect.width/2;
    const cy = rect.top + rect.height/2;
    return Math.atan2(clientY - cy, clientX - cx);
  }

  // pointer handlers for drag-to-spin
  function onPointerDown(e){
    isDragging = true;
    pointerVelSamples = [];
    lastPointerAngle = pointerAngle(e.clientX, e.clientY);
    lastPointerTime = performance.now();
    canvas.setPointerCapture(e.pointerId);
  }
  function onPointerMove(e){
    if(!isDragging) return;
    const now = performance.now();
    const angle = pointerAngle(e.clientX, e.clientY);
    let delta = angle - lastPointerAngle;
    // normalize delta to [-PI, PI]
    while(delta > Math.PI) delta -= 2*Math.PI;
    while(delta < -Math.PI) delta += 2*Math.PI;
    // apply immediate rotation (user dragging rotates disc)
    rotation += delta;
    // sample velocity
    const dt = Math.max(1, now - lastPointerTime);
    pointerVelSamples.push({v: delta / (dt/16.6667), t: now}); // normalized per frame
    if(pointerVelSamples.length > 6) pointerVelSamples.shift();
    lastPointerAngle = angle;
    lastPointerTime = now;
  }
  function onPointerUp(e){
    if(!isDragging) return;
    isDragging = false;
    // estimate velocity from recent samples
    if(pointerVelSamples.length){
      let sum=0, weight=0;
      for(let i=0;i<pointerVelSamples.length;i++){
        const age = (performance.now() - pointerVelSamples[i].t)/1000;
        const w = Math.max(0.1, 1 - age*2);
        sum += pointerVelSamples[i].v * w;
        weight += w;
      }
      let est = weight? sum/weight : 0;
      // scale by speed slider to allow stronger flicks at higher speed
      rotationVelocity = est * (Math.max(0.5, rotationSpeed*25));
    }
    pointerVelSamples = [];
  }

  // event binding for pointer drag (supports touch & mouse)
  canvas.addEventListener('pointerdown', onPointerDown);
  canvas.addEventListener('pointermove', onPointerMove);
  canvas.addEventListener('pointerup', onPointerUp);
  canvas.addEventListener('pointercancel', onPointerUp);
  canvas.addEventListener('pointerleave', onPointerUp);

  // auto-start for 2 minutes
  function startAuto(duration=120000){
    if(!isRunning){
      isRunning = true; indicator.classList.add('on'); startStop.textContent="‚è∏ Pause"; status.textContent="Auto-play";
      // seed a small velocity so it rotates immediately
      rotationVelocity = rotationSpeed;
    }
    if(autoStopTimer) clearTimeout(autoStopTimer);
    autoStopTimer = setTimeout(()=>{
      isRunning = false; indicator.classList.remove('on'); startStop.textContent="‚ñ∂Ô∏è Start"; status.textContent="Auto-play finished";
      autoStopTimer = null;
    }, duration);
  }

  // initial setup
  populateDropdown();
  resizeCanvas();
  render();
  physicsStep();

  // auto-play on load (2 minutes)
  startAuto(120000);

  // expose some console debugging
  console.log("Ready. Images:", imageFiles.length, "Default:", discSelect.value);

  // ensure canvas resizing on visibility change
  document.addEventListener('visibilitychange', () => { if(document.visibilityState==='visible') resizeCanvas(); });
};
</script>
</body>
</html>
