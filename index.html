<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Phenakistoscope Simulator (Fixed Load Image)</title>
<style>
  body {
    background: #111;
    color: #eee;
    font-family: monospace;
    text-align: center;
    margin: 0;
    padding: 20px;
  }
  canvas {
    background: #000;
    border: 2px solid #555;
    border-radius: 50%;
    display: block;
    margin: 20px auto;
  }
  .controls {
    margin-bottom: 10px;
  }
  button, input[type="file"], input[type="text"] {
    margin: 4px;
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid #555;
    background: #222;
    color: #eee;
  }
  #statusMessage {
    color: #ccc;
    font-size: 14px;
    margin-top: 8px;
  }
</style>
</head>
<body>
<h1>Phenakistoscope Simulator (Fixed Load Image)</h1>

<div class="controls">
  <input type="file" id="fileInput" accept="image/*" />
  <input type="text" id="imageUrlInput" placeholder="Enter image URL" size="40" />
  <button id="loadUrlBtn">Load URL</button>
  <button id="viewSwitchBtn">Switch View (Simulation / Realistic)</button>
  <button id="insetToggleBtn">Toggle Inset Window</button>
</div>

<canvas id="phenakistoscopeCanvas" width="800" height="800"></canvas>
<p id="statusMessage">Ready.</p>

<script>
console.log("Phenakistoscope Simulator - Fixed Version Starting...");

const canvas = document.getElementById('phenakistoscopeCanvas');
const ctx = canvas.getContext('2d');
const fileInput = document.getElementById('fileInput');
const imageUrlInput = document.getElementById('imageUrlInput');
const loadUrlBtn = document.getElementById('loadUrlBtn');
const viewSwitchBtn = document.getElementById('viewSwitchBtn');
const insetToggleBtn = document.getElementById('insetToggleBtn');
const statusMessage = document.getElementById('statusMessage');

let image = new Image();
let realisticBackground = new Image();
realisticBackground.src = "9965f708-6fd1-43a3-8b4a-9b29a187c1f8.png";

let rotation = 0;
let viewMode = "simulation";
let showInset = false;

function drawSimulation() {
  ctx.save();
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.translate(canvas.width / 2, canvas.height / 2);
  ctx.rotate(rotation);
  if (image && image.complete && image.naturalWidth > 0) {
    ctx.drawImage(image, -canvas.width / 2, -canvas.height / 2, canvas.width, canvas.height);
  }
  ctx.restore();
}

function drawRealistic() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (realisticBackground.complete && realisticBackground.naturalWidth > 0) {
    ctx.drawImage(realisticBackground, 0, 0, canvas.width, canvas.height);
  }
  ctx.save();
  ctx.translate(canvas.width / 2, canvas.height / 2);
  ctx.rotate(rotation);
  ctx.beginPath();
  ctx.arc(0, 0, canvas.width / 3, 0, Math.PI * 2);
  ctx.clip();
  if (image && image.complete && image.naturalWidth > 0) {
    ctx.drawImage(image, -canvas.width / 3, -canvas.height / 3, (canvas.width / 3) * 2, (canvas.height / 3) * 2);
  }
  ctx.restore();
}

function drawInset() {
  if (!showInset) return;
  const size = 200;
  const x = canvas.width - size - 20;
  const y = 20;
  ctx.save();
  ctx.beginPath();
  ctx.arc(x + size / 2, y + size / 2, size / 2, 0, Math.PI * 2);
  ctx.clip();
  ctx.translate(x + size / 2, y + size / 2);
  ctx.rotate(rotation);
  if (image && image.complete && image.naturalWidth > 0) {
    ctx.drawImage(image, -size / 2, -size / 2, size, size);
  }
  ctx.restore();
  ctx.strokeStyle = "#fff";
  ctx.lineWidth = 2;
  ctx.strokeRect(x, y, size, size);
}

function animate() {
  rotation += 0.02;
  if (viewMode === "simulation") drawSimulation();
  else drawRealistic();
  drawInset();
  requestAnimationFrame(animate);
}
animate();

// ✅ File upload via FileReader (base64 Data URL)
fileInput.addEventListener("change", function (e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (event) => {
    image = new Image();
    image.onload = () => {
      statusMessage.textContent = `✅ Loaded image: ${file.name}`;
      console.log("Loaded local image:", file.name);
    };
    image.src = event.target.result; // Base64 Data URL works online
  };
  reader.onerror = () => {
    statusMessage.textContent = "❌ Failed to load image.";
    console.error("FileReader error");
  };
  reader.readAsDataURL(file);
});

// ✅ Load image from URL
loadUrlBtn.addEventListener("click", function () {
  const url = imageUrlInput.value.trim();
  if (!url) {
    statusMessage.textContent = "⚠️ Please enter an image URL.";
    console.warn("No URL provided");
    return;
  }
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.onload = () => {
    image = img;
    statusMessage.textContent = `✅ Image loaded from URL: ${url}`;
    console.log("Loaded image from URL:", url);
  };
  img.onerror = () => {
    statusMessage.textContent = "❌ Could not load image (CORS restriction).";
    console.error("Failed to load image:", url);
  };
  img.src = url;
});

viewSwitchBtn.addEventListener("click", () => {
  viewMode = viewMode === "simulation" ? "realistic" : "simulation";
  statusMessage.textContent = `🔄 Switched to ${viewMode} view.`;
  console.log("Switched to", viewMode);
});

insetToggleBtn.addEventListener("click", () => {
  showInset = !showInset;
  statusMessage.textContent = showInset ? "🟢 Inset window shown." : "⚪ Inset window hidden.";
  console.log("Inset window:", showInset);
});
</script>
</body>
</html>